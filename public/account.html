<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="/m_logo.png">

  <title>Map My Travels</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link href="../node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="https://fonts.googleapis.com/css?family=Alfa+Slab+One|Cabin+Sketch|Kaushan+Script" rel="stylesheet">
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.css' rel='stylesheet'/>
  <link rel="stylesheet" href="../style/account.css">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>

<body>
  <div class="masthead">
      <h3 class="masthead-brand">Map My Travels</h3>
      <nav>
        <ul class="nav masthead-nav">
          <li class="active"><a href="/">Log Out</a></li>
        </ul>
      </nav>
  </div>

  <div id='map'></div>

  <div style="text-align:center;">
      <button id="saveButton" onclick="toggleEdit()">Edit Your Map</button>
  </div>

  <div id="editCountry">
    <input type="text" id="myInput" onkeyup="buildList()" placeholder="Search for countries or territories..">
    <ul id="myUL"></ul>
  </div>



  <div id="travelData">
    <h3>My Travel Data</h3>
    <select class="selectpicker" id="selector" onchange="drawChart();" style="margin-bottom:15px;">
      <option>Europe</option>
      <option>North America</option>
      <option>South America</option>
      <option>Africa</option>
      <option>Asia</option>
      <option>Oceania</option>
    </select>
    <div id="chartSection">
      <div id="piechart_3d" style="width: 900px; height: 500px; margin-left: 15px; float: left;"></div>
      <ul id='cList' style="float: left; font-family: Cabin Sketch; font-size: 20px; list-style-type: square; padding-top:55px;"></ul>
    </div>
  </div>

  <div class="mastfoot">
    <div class="inner">
      <p>Map My Travels, by <a>Kevin Irace</a>.</p>
    </div>
  </div>
  <script>
      let countries = [];
      let countriesInEurope = 51, countriesInAsia = 53, countriesInAfrica = 57, countriesInNA = 36, countriesInSA = 15, countriesInOceania = 23;

      mapboxgl.accessToken = 'pk.eyJ1Ijoia2V2aW5pcmFjZSIsImEiOiJjajY0M2ExZDIxbm1hMzNwOHp0cWpzbjJkIn0.g_KHQKSe60ViArp6hW-2TA';
      var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/kevinirace/cj65fkrkf67yv2qp0ik49zqeg',
          center: [10, 20],
          zoom: 2,
          interactive: true,
          minZoom: 2
      });

      map.scrollZoom.disable();
      map.addControl(new mapboxgl.NavigationControl());

      map.on('style.load', function () {
        $.get("/getCountries", function(data){
                //console.log(data);
                if(data !== null){
                  countries = data;
                }
                populateList();
                initializeMap();
                retrieveData();
        });
      });

      function retrieveData(){
        var parameter = location.search.substring(1);
        //console.log('parameter', parameter);
        var temp = parameter.split('=');
        //console.log('temp', temp);
        var userEmail = temp[1];
        current_user = userEmail;
        //console.log(userEmail);
        $.get("/getData", {email: userEmail} , function(data){
                //console.log(data);
                if(data !== null){
                  let user_countries = data;
                  for(i = 0; i < user_countries.length; i++){
                    toggleCountry(user_countries[i]);
                  }
                }
                google.charts.load("current", {packages:["corechart"]});
                google.charts.setOnLoadCallback(drawChart);
        });
      }

      function initializeMap(){
        for (x = 0; x < countries.length; x++){
          map.setLayoutProperty(countries[x][0], 'visibility', 'none');
        }
      }

      function toggleCountry(country){
        //console.log(country);
        var visibility = map.getLayoutProperty(country, 'visibility');
        //console.log(visibility);
        if (visibility === 'visible') {
            map.setLayoutProperty(country, 'visibility', 'none');
        } else {
            map.setLayoutProperty(country, 'visibility', 'visible');
        }
      }

      function populateList(){
        var list = document.getElementById('myUL');
        for (x = 0; x < countries.length; x++){
          var item = document.createElement('li');
          item.style.opacity = '0.5';
          var anc = document.createElement('a');
          var country = countries[x][0];
          anc.innerHTML = country;
          anc.onclick = function (){
            toggleCountry(this.innerHTML);
          }
          item.appendChild(anc);
          list.appendChild(item);
        }
      }

      function getVisitedCountries(continent){
        let numVisited = 0;
        let countryNames = [];
        for(let y = 0; y < countries.length; y++){
          if((map.getLayoutProperty(countries[y][0], 'visibility') == 'visible') && (countries[y][1] == continent)){
            console.log('visited! ', countries[y]);
            numVisited++;
            countryNames.push(countries[y][0]);
          }
        }
        let result = {number: numVisited, countries: countryNames};
        return result;
      }

      function buildList() {
          var input, filter, ul, li, a, i;
          input = document.getElementById('myInput');
          filter = input.value.toUpperCase();
          ul = document.getElementById("myUL");
          li = ul.getElementsByTagName('li');
          if (filter.length > 0){ ul.style.display = "block"; }
          else{ ul.style.display = "none";  }
          for (i = 0; i < li.length; i++){
              a = li[i].getElementsByTagName("a")[0];
              if (a.innerHTML.toUpperCase().indexOf(filter) > -1) { li[i].style.display = ""; }
              else {  li[i].style.display = "none"; }
          }
      }

      function toggleEdit(){  // toggle visibility of editing area
        var editArea = document.getElementById('editCountry');
        var button = document.getElementById('saveButton');
        if (editArea.style.visibility === "visible"){
          editArea.style.visibility= "hidden";
          button.innerHTML = "Edit Your Map";
          save2server();
        }
        else{
          editArea.style.visibility = "visible";
          button.innerHTML = "Submit Changes";
        }
      }

      function save2server(){
        let user_countries = [];
        for(let y = 0; y < countries.length; y++){
          if(map.getLayoutProperty(countries[y][0], 'visibility') == 'visible'){
            user_countries.push(countries[y][0]);
          }
        }
        $.post( "/saveData", {user: current_user, countries: user_countries}).done(function(data) {
        //alert( "Data Loaded: " + data );
        });
      }

      function setCountryList(list){
        let cList = document.getElementById('cList');
        cList.innerHTML = '';
        for(i = 0; i < list.length; i++){
          let item = document.createElement('li');
          item.innerHTML = list[i];
          cList.appendChild(item);
        }
      }

      function drawChart() {
        var selector = document.getElementById('selector');
        var currentContinent = selector.value;
        console.log(currentContinent);
        var totalCountries;
        if(currentContinent == 'North America'){ totalCountries = countriesInNA; }
        else if(currentContinent == 'South America'){ totalCountries = countriesInSA; }
        else if(currentContinent == 'Africa'){ totalCountries = countriesInAfrica; }
        else if(currentContinent == 'Europe'){ totalCountries = countriesInEurope; }
        else if(currentContinent == 'Asia'){ totalCountries = countriesInAsia; }
        else if(currentContinent == 'Oceania'){ totalCountries = countriesInOceania; }
        var res = getVisitedCountries(currentContinent);
        setCountryList(res.countries);
        var unvisitedCountries = totalCountries - res.number;

        var data = google.visualization.arrayToDataTable([
          ['Continent', 'Countries'],
          ['Visited',     res.number],
          ['Unvisited',   unvisitedCountries]
        ]);

        var options = {
          title: currentContinent,
          titleTextStyle: { color: 'white',
                            fontName: 'Cabin Sketch',
                            fontSize: 30,
                            bold: false,
                            italic: false },
          is3D: true,
          colors: ['#ad3232', '#d0d4db'],
          backgroundColor: '#55657f',
          legend: {position: 'top', textStyle: {color: 'white', fontSize: 16}}
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart_3d'));
        chart.draw(data, options);
      }

  </script>
  </body>
</html>
